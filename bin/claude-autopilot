#!/bin/bash

# æ™ºèƒ½Claude Autopilot 2.1é¡¹ç›®æ³¨å…¥è„šæœ¬
# åŠŸèƒ½ï¼šä¸ºé¡¹ç›®é…ç½®è½»é‡çº§Claude Autopilotç¯å¢ƒï¼Œé¿å…æ–‡ä»¶é‡å¤
# ç‰ˆæœ¬ï¼š2.0.0 - å¢å¼ºç‰ˆæœ¬ï¼Œæ”¯æŒæ™ºèƒ½é¡¹ç›®ç±»å‹æ£€æµ‹

set -e

# è®¾ç½®ç¼–ç ç¯å¢ƒï¼ˆå¦‚æœæ”¯æŒçš„è¯ï¼‰
export LANG=${LANG:-C.UTF-8}
if locale -a 2>/dev/null | grep -q "zh_CN.UTF-8"; then
    export LC_ALL=zh_CN.UTF-8
else
    export LC_ALL=C.UTF-8
fi

# æ˜¾ç¤ºä½¿ç”¨å¸®åŠ©
show_usage() {
    echo "ğŸ“– ä½¿ç”¨è¯´æ˜:"
    echo "   $0 [--target_dir <è·¯å¾„>] [--project_type <ç±»å‹>] [--owner <æ‰€æœ‰è€…>]"
    echo ""
    echo "ğŸ“‹ å‚æ•°è¯´æ˜:"
    echo "   --target_dir  - ç›®æ ‡ç›®å½• (å¯é€‰ï¼Œé»˜è®¤å½“å‰ç›®å½•)"
    echo "                   ç»å¯¹è·¯å¾„: /path/to/project"
    echo "                   ç›¸å¯¹è·¯å¾„: my-project (åœ¨å½“å‰ç›®å½•ä¸‹åˆ›å»º)"
    echo "   --project_type - é¡¹ç›®ç±»å‹ (å¯é€‰ï¼Œä¸æä¾›åˆ™äº¤äº’é€‰æ‹©)"
    echo "   --owner       - é¡¹ç›®æ‰€æœ‰è€… (å¯é€‰ï¼Œä¸æä¾›åˆ™è‡ªåŠ¨ç”Ÿæˆ)"
    echo ""
    echo "ğŸ¯ ä½¿ç”¨ç¤ºä¾‹:"
    echo "   $0                                    # å®Œå…¨äº¤äº’å¼"
    echo "   $0 --target_dir ./my-app              # æŒ‡å®šç›®å½•"
    echo "   $0 --project_type bash-scripts        # æŒ‡å®šç±»å‹"
    echo "   $0 --owner 'YoumiSam'                 # æŒ‡å®šæ‰€æœ‰è€…"
    echo "   $0 --target_dir /opt/app --project_type gin-microservice --owner 'Team'  # å®Œæ•´å‚æ•°"
    echo ""
    echo "ğŸ†• é¡¹ç›®æ¨¡å¼è¯´æ˜:"
    echo "   - ç©ºç›®å½•/ä¸å­˜åœ¨ç›®å½•: æ–°å»ºé¡¹ç›®æ¨¡å¼"
    echo "   - ç°æœ‰Claudeé¡¹ç›®: æ³¨å…¥æ›´æ–°æ¨¡å¼ (ä¿æŠ¤ç°æœ‰ç»“æ„)"
    echo "   - éç©ºéé¡¹ç›®ç›®å½•: éœ€è¦ç”¨æˆ·ç¡®è®¤"
    echo ""
    echo "ğŸ·ï¸ æ”¯æŒçš„é¡¹ç›®ç±»å‹:"
    echo "   gin-microservice  - Go + Ginå¾®æœåŠ¡"
    echo "   gin-vue3         - Go + Gin + Vue3å…¨æ ˆ"
    echo "   go-desktop       - Goæ¡Œé¢åº”ç”¨"
    echo "   go-general       - Goé€šç”¨é¡¹ç›®"
    echo "   vue3-frontend    - Vue3å‰ç«¯é¡¹ç›®"
    echo "   vue2-frontend    - Vue2å‰ç«¯é¡¹ç›®"
    echo "   react-frontend   - Reactå‰ç«¯é¡¹ç›®"
    echo "   nextjs-frontend  - Next.jså‰ç«¯é¡¹ç›®"
    echo "   nodejs-general   - Node.jsé€šç”¨é¡¹ç›®"
    echo "   python-desktop   - Pythonæ¡Œé¢åº”ç”¨"
    echo "   django           - Django Webåº”ç”¨"
    echo "   python-general   - Pythoné€šç”¨é¡¹ç›®"
    echo "   fastapi_vue3     - FastAPI + Vue3å…¨æ ˆ"
    echo "   bash-scripts     - Bashè„šæœ¬é¡¹ç›®"
    echo "   java-maven       - Java Mavené¡¹ç›®"
    echo "   java-gradle      - Java Gradleé¡¹ç›®"
    echo "   rust-project     - Rusté¡¹ç›®"
    echo "   php-project      - PHPé¡¹ç›®"
    echo ""
}

# ç”ŸæˆUUID7æ ¼å¼çš„project_id
generate_uuid7() {
    # UUID7 ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºå‰ç¼€ï¼Œç¡®ä¿æ—¶é—´é¡ºåºæ€§
    # æ ¼å¼: xxxxxxxx-xxxx-7xxx-yxxx-xxxxxxxxxxxx
    # å…¶ä¸­å‰48ä½æ˜¯æ¯«ç§’æ—¶é—´æˆ³ï¼Œç‰ˆæœ¬å·ä¸º7
    
    # è·å–å½“å‰æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
    if command -v python3 >/dev/null 2>&1; then
        # ä½¿ç”¨Pythonç”Ÿæˆæ›´ç²¾ç¡®çš„UUID7
        python3 -c "
import time
import random
import uuid

# è·å–å½“å‰æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
timestamp_ms = int(time.time() * 1000)

# è½¬æ¢ä¸º48ä½åå…­è¿›åˆ¶
timestamp_hex = format(timestamp_ms, '012x')

# ç”Ÿæˆéšæœºéƒ¨åˆ†
rand_a = random.randint(0, 0xfff)  # 12ä½éšæœºæ•°
rand_b = random.randint(0, 0x3fff) | 0x8000  # 14ä½éšæœºæ•°ï¼Œè®¾ç½®variantä½
rand_c = random.randint(0, 0xffffffffffff)  # 48ä½éšæœºæ•°

# æ„é€ UUID7
uuid7 = f'{timestamp_hex[:8]}-{timestamp_hex[8:]}-7{rand_a:03x}-{rand_b:04x}-{rand_c:012x}'
print(uuid7)
"
    else
        # å›é€€æ–¹æ¡ˆï¼šä½¿ç”¨shellç”Ÿæˆç±»ä¼¼UUID7çš„æ ¼å¼
        timestamp=$(date +%s%3N)  # è·å–æ¯«ç§’æ—¶é—´æˆ³
        timestamp_hex=$(printf "%012x" $timestamp)
        
        # ç”Ÿæˆéšæœºéƒ¨åˆ†
        rand1=$(printf "%03x" $((RANDOM % 4096)))
        rand2=$(printf "%04x" $((RANDOM % 16384 + 32768)))  # è®¾ç½®variantä½
        rand3=$(printf "%012x" $((RANDOM * RANDOM * RANDOM % 281474976710656)))
        
        echo "${timestamp_hex:0:8}-${timestamp_hex:8:4}-7${rand1}-${rand2}-${rand3}"
    fi
}

# é¡¹ç›®çŠ¶æ€æ£€æµ‹å‡½æ•°
detect_project_status() {
    local target_dir="$1"
    
    # 1. æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
    if [ ! -d "$target_dir" ]; then
        echo "CREATE_NEW"
        return
    fi
    
    # 2. æ£€æŸ¥æ˜¯å¦ä¸ºç©ºç›®å½• (å¿½ç•¥éšè—æ–‡ä»¶)
    if [ -z "$(find "$target_dir" -maxdepth 1 -not -path "$target_dir" -not -name ".*" -print -quit)" ]; then
        echo "CREATE_NEW"
        return
    fi
    
    # 3. æ£€æŸ¥æ˜¯å¦ä¸ºç°æœ‰é¡¹ç›® (æ£€æµ‹é¡¹ç›®æ ‡è¯†æ–‡ä»¶)
    if [ -f "$target_dir/CLAUDE.md" ] || [ -f "$target_dir/.claude/project.json" ]; then
        echo "INJECT_EXISTING"
        return
    fi
    
    # 4. éç©ºéé¡¹ç›®ç›®å½•
    echo "NON_EMPTY_NON_PROJECT"
}

# éªŒè¯é¡¹ç›®ç±»å‹æœ‰æ•ˆæ€§
validate_project_type() {
    local project_type="$1"
    local valid_types="gin-microservice gin-vue3 go-desktop go-general vue3-frontend vue2-frontend react-frontend nextjs-frontend nodejs-general python-desktop django python-general fastapi_vue3 bash-scripts java-maven java-gradle rust-project php-project"
    
    echo "$valid_types" | grep -wq "$project_type"
}

# æ˜¾ç¤ºæœ‰æ•ˆé¡¹ç›®ç±»å‹åˆ—è¡¨
show_valid_project_types() {
    echo "ğŸ“‹ æœ‰æ•ˆçš„é¡¹ç›®ç±»å‹:"
    echo "   1) gin-microservice    (Go + Ginå¾®æœåŠ¡)"
    echo "   2) gin-vue3           (Go + Gin + Vue3å…¨æ ˆ)"
    echo "   3) go-desktop         (Goæ¡Œé¢åº”ç”¨)"
    echo "   4) go-general         (Goé€šç”¨é¡¹ç›®)"
    echo "   5) vue3-frontend      (Vue3å‰ç«¯é¡¹ç›®)"
    echo "   6) vue2-frontend      (Vue2å‰ç«¯é¡¹ç›®)"
    echo "   7) react-frontend     (Reactå‰ç«¯é¡¹ç›®)"
    echo "   8) nextjs-frontend    (Next.jså‰ç«¯é¡¹ç›®)"
    echo "   9) nodejs-general     (Node.jsé€šç”¨é¡¹ç›®)"
    echo "   10) python-desktop     (Pythonæ¡Œé¢åº”ç”¨)"
    echo "   11) django             (Django Webåº”ç”¨)"
    echo "   12) python-general     (Pythoné€šç”¨é¡¹ç›®)"
    echo "   13) fastapi_vue3       (FastAPI + Vue3å…¨æ ˆ)"
    echo "   14) bash-scripts       (Bashè„šæœ¬é¡¹ç›®)"
    echo "   15) java-maven         (Java Mavené¡¹ç›®)"
    echo "   16) java-gradle        (Java Gradleé¡¹ç›®)"
    echo "   17) rust-project       (Rusté¡¹ç›®)"
    echo "   18) php-project        (PHPé¡¹ç›®)"
}

# äº¤äº’å¼é€‰æ‹©é¡¹ç›®ç±»å‹
interactive_select_project_type() {
    echo ""
    show_valid_project_types
    echo ""
    
    while true; do
        read -r -p "è¯·è¾“å…¥é€‰é¡¹ç¼–å· (1-18): " choice
        
        case "$choice" in
            1) echo "gin-microservice"; return ;;
            2) echo "gin-vue3"; return ;;
            3) echo "go-desktop"; return ;;
            4) echo "go-general"; return ;;
            5) echo "vue3-frontend"; return ;;
            6) echo "vue2-frontend"; return ;;
            7) echo "react-frontend"; return ;;
            8) echo "nextjs-frontend"; return ;;
            9) echo "nodejs-general"; return ;;
            10) echo "python-desktop"; return ;;
            11) echo "django"; return ;;
            12) echo "python-general"; return ;;
            13) echo "fastapi_vue3"; return ;;
            14) echo "bash-scripts"; return ;;
            15) echo "java-maven"; return ;;
            16) echo "java-gradle"; return ;;
            17) echo "rust-project"; return ;;
            18) echo "php-project"; return ;;
            *)
                echo "âŒ æ— æ•ˆé€‰æ‹©ï¼Œè¯·è¾“å…¥ 1-18 ä¹‹é—´çš„æ•°å­—"
                ;;
        esac
    done
}

# æ£€æµ‹æŠ€æœ¯æ ˆ
detect_tech_stack() {
    local path="$1"
    local project_type="$2"
    local tech_stack=""

    case "$project_type" in
        "gin-microservice")
            tech_stack="Go + Gin"
            if [ -f "$path/go.mod" ]; then
                if grep -q "gorm" "$path/go.mod"; then
                    tech_stack="$tech_stack + GORM"
                fi
                if grep -q "redis" "$path/go.mod"; then
                    tech_stack="$tech_stack + Redis"
                fi
            fi
            ;;
        "vue3-frontend")
            tech_stack="Vue3 + TypeScript"
            if [ -f "$path/package.json" ]; then
                if grep -q "vite" "$path/package.json"; then
                    tech_stack="$tech_stack + Vite"
                fi
                if grep -q "pinia" "$path/package.json"; then
                    tech_stack="$tech_stack + Pinia"
                fi
            fi
            ;;
        "python-desktop")
            tech_stack="Python"
            if find "$path" -name "*.py" -exec grep -l "tkinter" {} \; 2>/dev/null | head -1 | grep -q .; then
                tech_stack="$tech_stack + Tkinter"
            fi
            if find "$path" -name "*.py" -exec grep -l "PyQt" {} \; 2>/dev/null | head -1 | grep -q .; then
                tech_stack="$tech_stack + PyQt"
            fi
            ;;
        "bash-scripts")
            tech_stack="bash-scripts"
            if [ -f "$path/Makefile" ]; then
                tech_stack="$tech_stack + Make"
            fi
            if find "$path" -name "*.sh" | grep -q test; then
                tech_stack="$tech_stack + Tests"
            fi
            ;;
        *)
            tech_stack="$project_type"
            ;;
    esac

    echo "$tech_stack"
}

# åŠ è½½å¿…è¦çš„åº“å‡½æ•°
load_required_libraries() {
    echo "ğŸ“š åŠ è½½å¿…è¦çš„åº“å‡½æ•°..."
    
    # æ£€æŸ¥å¹¶åŠ è½½æ ¸å¿ƒåº“æ–‡ä»¶
    local lib_files=(
        "project-health-assessment.sh"
        "project-structure-creator.sh" 
        "deployment-strategy-manager.sh"
        "internationalization-manager.sh"
        "alias-resolver.sh"
    )
    
    for lib_file in "${lib_files[@]}"; do
        local lib_path="$GLOBAL_RULES_PATH/lib/$lib_file"
        if [ -f "$lib_path" ]; then
            echo "   âœ… åŠ è½½: $lib_file"
            source "$lib_path" 2>/dev/null || {
                echo "   âš ï¸ è­¦å‘Š: æ— æ³•åŠ è½½ $lib_fileï¼Œè·³è¿‡"
            }
        else
            echo "   âš ï¸ è­¦å‘Š: æœªæ‰¾åˆ° $lib_fileï¼Œè·³è¿‡"
        fi
    done
    
    echo "   âœ… åº“å‡½æ•°åŠ è½½å®Œæˆ"
}

echo "ğŸ›©ï¸ Claude Autopilot 2.1 æ™ºèƒ½é¡¹ç›®é…ç½®å™¨"
echo "================================================"

# è·¨å¹³å°realpathå‡½æ•°
get_realpath() {
    if command -v realpath >/dev/null 2>&1; then
        realpath "$1"
    else
        # å…¼å®¹macOSç­‰æ²¡æœ‰realpathçš„ç³»ç»Ÿ
        cd "$(dirname "$1")" && echo "$(pwd)/$(basename "$1")"
    fi
}

# åŠ¨æ€æ£€æµ‹è„šæœ¬è·¯å¾„ - è‡ªåŠ¨è·å–claude-autopilotæ ¹ç›®å½•
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# è„šæœ¬åœ¨ bin/ ç›®å½•ä¸‹ï¼Œæ‰€ä»¥ä¸Šçº§ç›®å½•å°±æ˜¯ claude-autopilot æ ¹ç›®å½•
CLAUDE_AUTOPILOT_ROOT="$(dirname "$SCRIPT_DIR")"
GLOBAL_RULES_PATH="$CLAUDE_AUTOPILOT_ROOT"
GLOBAL_CE_PATH="$CLAUDE_AUTOPILOT_ROOT/share/claude-autopilot"
SCRIPT_VERSION="2.0.0"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

# å¯¼å‡ºå…¨å±€è·¯å¾„å˜é‡ä¾›å­è„šæœ¬ä½¿ç”¨
export GLOBAL_RULES_PATH
export GLOBAL_CE_PATH

# è°ƒè¯•ä¿¡æ¯
echo "ğŸ” å…¨å±€è·¯å¾„è°ƒè¯•:"
echo "   GLOBAL_RULES_PATH: $GLOBAL_RULES_PATH"
echo "   GLOBAL_CE_PATH: $GLOBAL_CE_PATH"

# æ–°çš„å‚æ•°è§£æç³»ç»Ÿ
TARGET_DIR=""
PROJECT_TYPE=""
OWNER=""

# å‚æ•°è§£æ
while [[ $# -gt 0 ]]; do
    case $1 in
        --target_dir)
            if [ -z "$2" ] || [[ "$2" == --* ]]; then
                echo "âŒ é”™è¯¯: --target_dir éœ€è¦æä¾›ç›®å½•è·¯å¾„"
                exit 1
            fi
            TARGET_DIR="$2"
            shift 2
            ;;
        --project_type)
            if [ -z "$2" ] || [[ "$2" == --* ]]; then
                echo "âŒ é”™è¯¯: --project_type éœ€è¦æä¾›é¡¹ç›®ç±»å‹"
                exit 1
            fi
            PROJECT_TYPE="$2"
            shift 2
            ;;
        --owner)
            if [ -z "$2" ] || [[ "$2" == --* ]]; then
                echo "âŒ é”™è¯¯: --owner éœ€è¦æä¾›æ‰€æœ‰è€…åç§°"
                exit 1
            fi
            OWNER="$2"
            shift 2
            ;;
        -h|--help)
            show_usage
            exit 0
            ;;
        -v|--version)
            echo "Claude Autopilot v2.1.0"
            exit 0
            ;;
        *)
            echo "âŒ é”™è¯¯: æœªçŸ¥å‚æ•° $1"
            echo ""
            show_usage
            exit 1
            ;;
    esac
done

# å¤„ç†target_dirå‚æ•°
if [ -z "$TARGET_DIR" ]; then
    # æœªæä¾›target_dirï¼Œä½¿ç”¨å½“å‰ç›®å½•
    TARGET_DIR=$(pwd)
    echo "ğŸ“‚ ä½¿ç”¨å½“å‰ç›®å½•: $TARGET_DIR"
elif [[ "$TARGET_DIR" == /* ]]; then
    # ç»å¯¹è·¯å¾„
    echo "ğŸ“‚ ä½¿ç”¨ç»å¯¹è·¯å¾„: $TARGET_DIR"
else
    # ç›¸å¯¹è·¯å¾„ï¼Œåœ¨å½“å‰ç›®å½•ä¸‹åˆ›å»º
    TARGET_DIR="$(pwd)/$TARGET_DIR"
    echo "ğŸ“‚ ç›¸å¯¹è·¯å¾„è½¬æ¢ä¸º: $TARGET_DIR"
fi

# è§„èŒƒåŒ–è·¯å¾„
if [ -d "$TARGET_DIR" ]; then
    TARGET_DIR=$(get_realpath "$TARGET_DIR")
fi

echo "ğŸ“‚ æœ€ç»ˆç›®æ ‡ç›®å½•: $TARGET_DIR"
echo "ğŸ”§ Claude Autopilotè·¯å¾„: $GLOBAL_CE_PATH"
echo ""

# æ£€æµ‹é¡¹ç›®çŠ¶æ€
echo "ğŸ” æ£€æµ‹é¡¹ç›®çŠ¶æ€..."
PROJECT_STATUS=$(detect_project_status "$TARGET_DIR")
echo "   çŠ¶æ€: $PROJECT_STATUS"
echo ""

# å‡½æ•°å®šä¹‰ï¼šå¤„ç†CREATE_NEWæ¨¡å¼
handle_create_new_mode() {
    echo "ğŸ†• æ–°å»ºé¡¹ç›®æ¨¡å¼"
    echo "================================================"
    
    # åˆ›å»ºç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    if [ ! -d "$TARGET_DIR" ]; then
        echo "ğŸ“ åˆ›å»ºç›®å½•: $TARGET_DIR"
        mkdir -p "$TARGET_DIR" || {
            echo "âŒ é”™è¯¯: æ— æ³•åˆ›å»ºç›®å½• $TARGET_DIR"
            exit 1
        }
    fi
    
    # å¤„ç†é¡¹ç›®ç±»å‹
    if [ -n "$PROJECT_TYPE" ]; then
        if validate_project_type "$PROJECT_TYPE"; then
            echo "âœ… ä½¿ç”¨æŒ‡å®šçš„é¡¹ç›®ç±»å‹: $PROJECT_TYPE"
            FINAL_PROJECT_TYPE="$PROJECT_TYPE"
        else
            echo "âŒ é¡¹ç›®ç±»å‹ '$PROJECT_TYPE' æ— æ•ˆ"
            show_valid_project_types
            echo ""
            echo "è¯·ä»æœ‰æ•ˆç±»å‹ä¸­é€‰æ‹©:"
            FINAL_PROJECT_TYPE=$(interactive_select_project_type)
        fi
    else
        echo "ğŸ“‹ è¯·é€‰æ‹©é¡¹ç›®ç±»å‹:"
        FINAL_PROJECT_TYPE=$(interactive_select_project_type)
    fi
    echo "   âœ… æœ€ç»ˆé¡¹ç›®ç±»å‹: $FINAL_PROJECT_TYPE"
    
    # å¤„ç†Owner
    if [ -n "$OWNER" ]; then
        echo "ğŸ‘¤ ä½¿ç”¨æŒ‡å®šçš„owner: $OWNER"
        FINAL_OWNER="$OWNER"
    else
        echo ""
        read -r -p "ğŸ‘¤ è¯·è¾“å…¥é¡¹ç›®æ‰€æœ‰è€… (ç•™ç©ºåˆ™è‡ªåŠ¨ç”ŸæˆUUID): " input_owner
        if [ -n "$input_owner" ]; then
            FINAL_OWNER="$input_owner"
        else
            FINAL_OWNER=""  # å°†åœ¨åé¢ç”ŸæˆUUID
        fi
    fi
    
    # ç”Ÿæˆé¡¹ç›®IDå’Œè®¾ç½®owner
    PROJECT_ID=$(generate_uuid7)
    if [ -z "$FINAL_OWNER" ]; then
        FINAL_OWNER="$PROJECT_ID"
        echo "   â„¹ï¸ owneræœªæä¾›ï¼Œä½¿ç”¨project_id: $FINAL_OWNER"
    else
        echo "   âœ… æœ€ç»ˆowner: $FINAL_OWNER"
    fi
    
    echo "   ğŸ†” é¡¹ç›®ID: $PROJECT_ID"
    echo ""
    
    # ç»§ç»­åŸæœ‰çš„åˆ›å»ºæµç¨‹
    continue_create_project_flow
}

# å‡½æ•°å®šä¹‰ï¼šå¤„ç†INJECT_EXISTINGæ¨¡å¼  
handle_inject_existing_mode() {
    echo "ğŸ”„ ç°æœ‰é¡¹ç›®æ³¨å…¥æ¨¡å¼"
    echo "================================================"
    
    # è¯»å–ç°æœ‰é¡¹ç›®é…ç½®
    EXISTING_CONFIG="$TARGET_DIR/.claude/project.json"
    EXISTING_CLAUDE_MD="$TARGET_DIR/CLAUDE.md"
    
    EXISTING_PROJECT_TYPE=""
    EXISTING_OWNER=""
    EXISTING_PROJECT_ID=""
    
    # å°è¯•ä»project.jsonè¯»å–ç°æœ‰é…ç½®
    if [ -f "$EXISTING_CONFIG" ]; then
        echo "ğŸ“– è¯»å–ç°æœ‰é…ç½®: .claude/project.json"
        if command -v jq >/dev/null 2>&1; then
            EXISTING_PROJECT_TYPE=$(jq -r '.project_type // empty' "$EXISTING_CONFIG" 2>/dev/null)
            EXISTING_OWNER=$(jq -r '.owner // empty' "$EXISTING_CONFIG" 2>/dev/null)  
            EXISTING_PROJECT_ID=$(jq -r '.project_id // empty' "$EXISTING_CONFIG" 2>/dev/null)
        else
            # ç®€å•çš„grepæ–¹å¼è§£æJSONï¼ˆä¸å®Œç¾ä½†å¯ç”¨ï¼‰
            EXISTING_PROJECT_TYPE=$(grep -o '"project_type"[[:space:]]*:[[:space:]]*"[^"]*"' "$EXISTING_CONFIG" 2>/dev/null | sed 's/.*"\\([^"]*\\)".*/\\1/')
            EXISTING_OWNER=$(grep -o '"owner"[[:space:]]*:[[:space:]]*"[^"]*"' "$EXISTING_CONFIG" 2>/dev/null | sed 's/.*"\\([^"]*\\)".*/\\1/')
            EXISTING_PROJECT_ID=$(grep -o '"project_id"[[:space:]]*:[[:space:]]*"[^"]*"' "$EXISTING_CONFIG" 2>/dev/null | sed 's/.*"\\([^"]*\\)".*/\\1/')
        fi
        
        [ -n "$EXISTING_PROJECT_TYPE" ] && echo "   ç°æœ‰é¡¹ç›®ç±»å‹: $EXISTING_PROJECT_TYPE"
        [ -n "$EXISTING_OWNER" ] && echo "   ç°æœ‰owner: $EXISTING_OWNER"  
        [ -n "$EXISTING_PROJECT_ID" ] && echo "   ç°æœ‰é¡¹ç›®ID: $EXISTING_PROJECT_ID"
    fi
    
    # å¤„ç†é¡¹ç›®ç±»å‹
    if [ -n "$EXISTING_PROJECT_TYPE" ] && [ -n "$PROJECT_TYPE" ]; then
        echo ""
        echo "âš ï¸  æ£€æµ‹åˆ°ç°æœ‰é¡¹ç›®ç±»å‹: $EXISTING_PROJECT_TYPE"
        echo "âš ï¸  å‚æ•°æŒ‡å®šé¡¹ç›®ç±»å‹: $PROJECT_TYPE"
        read -r -p "æ˜¯å¦è¦†ç›–ç°æœ‰é¡¹ç›®ç±»å‹ä¸º '$PROJECT_TYPE'ï¼Ÿ(y/N): " confirm
        if [[ "$confirm" =~ ^[Yy]$ ]]; then
            FINAL_PROJECT_TYPE="$PROJECT_TYPE"
            echo "   âœ… é¡¹ç›®ç±»å‹å·²æ›´æ–°ä¸º: $FINAL_PROJECT_TYPE"
        else
            FINAL_PROJECT_TYPE="$EXISTING_PROJECT_TYPE"
            echo "   âœ… ä¿æŒç°æœ‰é¡¹ç›®ç±»å‹: $FINAL_PROJECT_TYPE"
        fi
    elif [ -n "$EXISTING_PROJECT_TYPE" ]; then
        read -r -p "ä¿æŒç°æœ‰é¡¹ç›®ç±»å‹ '$EXISTING_PROJECT_TYPE'ï¼Ÿ(Y/n): " confirm
        if [[ "$confirm" =~ ^[Nn]$ ]]; then
            echo "ğŸ“‹ è¯·é€‰æ‹©æ–°çš„é¡¹ç›®ç±»å‹:"
            FINAL_PROJECT_TYPE=$(interactive_select_project_type)
        else
            FINAL_PROJECT_TYPE="$EXISTING_PROJECT_TYPE"
        fi
        echo "   âœ… æœ€ç»ˆé¡¹ç›®ç±»å‹: $FINAL_PROJECT_TYPE"
    elif [ -n "$PROJECT_TYPE" ]; then
        if validate_project_type "$PROJECT_TYPE"; then
            FINAL_PROJECT_TYPE="$PROJECT_TYPE"
            echo "   âœ… è®¾ç½®é¡¹ç›®ç±»å‹: $FINAL_PROJECT_TYPE"
        else
            echo "âŒ é¡¹ç›®ç±»å‹ '$PROJECT_TYPE' æ— æ•ˆ"
            echo "ğŸ“‹ è¯·é€‰æ‹©æœ‰æ•ˆçš„é¡¹ç›®ç±»å‹:"
            FINAL_PROJECT_TYPE=$(interactive_select_project_type)
        fi
    else
        echo "ğŸ“‹ è¯·é€‰æ‹©é¡¹ç›®ç±»å‹:"
        FINAL_PROJECT_TYPE=$(interactive_select_project_type)
    fi
    
    # å¤„ç†Owner
    if [ -n "$EXISTING_OWNER" ] && [ -n "$OWNER" ]; then
        echo ""
        echo "âš ï¸  æ£€æµ‹åˆ°ç°æœ‰owner: $EXISTING_OWNER"
        echo "âš ï¸  å‚æ•°æŒ‡å®šowner: $OWNER"
        read -r -p "æ˜¯å¦è¦†ç›–ç°æœ‰ownerä¸º '$OWNER'ï¼Ÿ(y/N): " confirm
        if [[ "$confirm" =~ ^[Yy]$ ]]; then
            FINAL_OWNER="$OWNER"
            echo "   âœ… Ownerå·²æ›´æ–°ä¸º: $FINAL_OWNER"
        else
            FINAL_OWNER="$EXISTING_OWNER"
            echo "   âœ… ä¿æŒç°æœ‰owner: $FINAL_OWNER"
        fi
    elif [ -n "$EXISTING_OWNER" ]; then
        read -r -p "ä¿æŒç°æœ‰owner '$EXISTING_OWNER'ï¼Ÿ(Y/n): " confirm
        if [[ "$confirm" =~ ^[Nn]$ ]]; then
            read -r -p "è¯·è¾“å…¥æ–°çš„owner: " new_owner
            FINAL_OWNER="${new_owner:-$EXISTING_OWNER}"
        else
            FINAL_OWNER="$EXISTING_OWNER"
        fi
        echo "   âœ… æœ€ç»ˆowner: $FINAL_OWNER"
    elif [ -n "$OWNER" ]; then
        FINAL_OWNER="$OWNER"
        echo "   âœ… è®¾ç½®owner: $FINAL_OWNER"
    else
        read -r -p "è¯·è¾“å…¥owner (ç•™ç©ºåˆ™è‡ªåŠ¨ç”Ÿæˆ): " input_owner
        FINAL_OWNER="$input_owner"
    fi
    
    # å¤„ç†é¡¹ç›®IDï¼ˆæ³¨å…¥æ¨¡å¼ä¿æŒç°æœ‰IDæˆ–ç”Ÿæˆæ–°çš„ï¼‰
    if [ -n "$EXISTING_PROJECT_ID" ]; then
        PROJECT_ID="$EXISTING_PROJECT_ID"
        echo "   ğŸ†” ä¿æŒç°æœ‰é¡¹ç›®ID: $PROJECT_ID"
    else
        PROJECT_ID=$(generate_uuid7)
        echo "   ğŸ†” ç”Ÿæˆæ–°é¡¹ç›®ID: $PROJECT_ID"
    fi
    
    # å¦‚æœownerä¸ºç©ºï¼Œä½¿ç”¨project_id
    if [ -z "$FINAL_OWNER" ]; then
        FINAL_OWNER="$PROJECT_ID"
        echo "   â„¹ï¸ owneræœªæä¾›ï¼Œä½¿ç”¨project_id: $FINAL_OWNER"
    fi
    
    echo ""
    
    # ç»§ç»­æ³¨å…¥æµç¨‹
    continue_inject_project_flow
}

# å‡½æ•°å®šä¹‰ï¼šå¤„ç†NON_EMPTY_NON_PROJECTæ¨¡å¼
handle_non_empty_non_project_mode() {
    echo "âš ï¸  éç©ºéé¡¹ç›®ç›®å½•"
    echo "================================================"
    
    echo "ç›®å½• '$TARGET_DIR' éç©ºä¸”ä¸æ˜¯Claudeé¡¹ç›®"
    echo ""
    echo "ğŸ“ ç›®å½•å†…å®¹æ¦‚è§ˆ:"
    ls -la "$TARGET_DIR" | head -6
    if [ "$(ls -1 "$TARGET_DIR" | wc -l)" -gt 5 ]; then
        echo "... (æ›´å¤šæ–‡ä»¶)"
    fi
    echo ""
    
    read -r -p "âš ï¸  æ˜¯å¦ç»§ç»­åœ¨æ­¤ç›®å½•åˆ›å»ºé¡¹ç›®ï¼Ÿè¿™å¯èƒ½è¦†ç›–ç°æœ‰æ–‡ä»¶ (y/N): " confirm
    if [[ "$confirm" =~ ^[Yy]$ ]]; then
        echo "âœ… ç”¨æˆ·ç¡®è®¤ç»§ç»­ï¼Œè½¬ä¸ºæ–°å»ºé¡¹ç›®æ¨¡å¼"
        PROJECT_STATUS="CREATE_NEW"
        handle_create_new_mode
    else
        echo "âŒ æ“ä½œå·²å–æ¶ˆ"
        echo "ğŸ’¡ å»ºè®®: è¯·é€‰æ‹©å…¶ä»–ç›®å½•æˆ–æ¸…ç©ºå½“å‰ç›®å½•åé‡è¯•"
        exit 1
    fi
}

# ç»§ç»­æ–°å»ºé¡¹ç›®æµç¨‹
continue_create_project_flow() {
    echo "ğŸš€ å¼€å§‹åˆ›å»ºé¡¹ç›®..."
    
    # è®¾ç½®é¡¹ç›®å˜é‡
    PROJECT_NAME=$(basename "$TARGET_DIR")
    TECH_STACK=$(detect_tech_stack "$TARGET_DIR" "$FINAL_PROJECT_TYPE")
    
    echo "ğŸ“Š é¡¹ç›®ä¿¡æ¯æ±‡æ€»:"
    echo "   ğŸ“‚ é¡¹ç›®åç§°: $PROJECT_NAME"
    echo "   ğŸ·ï¸ é¡¹ç›®ç±»å‹: $FINAL_PROJECT_TYPE"
    echo "   ğŸ”§ æŠ€æœ¯æ ˆ: $TECH_STACK"
    echo "   ğŸ‘¤ é¡¹ç›®æ‰€æœ‰è€…: $FINAL_OWNER"
    echo "   ğŸ†” é¡¹ç›®ID: $PROJECT_ID"
    echo ""
    
    # æ‰§è¡Œé¡¹ç›®å¥åº·åº¦è¯„ä¼°
    echo "ğŸ¥ æ‰§è¡Œé¡¹ç›®å¥åº·åº¦è¯„ä¼°..."
    # æ–°é¡¹ç›®å¥åº·åº¦ä¸º0
    HEALTH_PERCENTAGE=0
    echo "ğŸ“Š é¡¹ç›®å¥åº·åº¦: $HEALTH_PERCENTAGE%"
    echo ""
    
    # åŠ è½½å¿…è¦çš„åº“å‡½æ•°
    load_required_libraries
    
    # æ‰§è¡ŒåŸæœ‰çš„é¡¹ç›®åˆ›å»ºæµç¨‹
    execute_project_creation
}

# ç»§ç»­æ³¨å…¥é¡¹ç›®æµç¨‹  
continue_inject_project_flow() {
    echo "ğŸ”„ å¼€å§‹æ³¨å…¥é…ç½®..."
    
    # è®¾ç½®é¡¹ç›®å˜é‡
    PROJECT_NAME=$(basename "$TARGET_DIR")
    TECH_STACK=$(detect_tech_stack "$TARGET_DIR" "$FINAL_PROJECT_TYPE")
    
    echo "ğŸ“Š é¡¹ç›®ä¿¡æ¯æ±‡æ€»:"
    echo "   ğŸ“‚ é¡¹ç›®åç§°: $PROJECT_NAME"
    echo "   ğŸ·ï¸ é¡¹ç›®ç±»å‹: $FINAL_PROJECT_TYPE"
    echo "   ğŸ”§ æŠ€æœ¯æ ˆ: $TECH_STACK"
    echo "   ğŸ‘¤ é¡¹ç›®æ‰€æœ‰è€…: $FINAL_OWNER"
    echo "   ğŸ†” é¡¹ç›®ID: $PROJECT_ID"
    echo ""
    
    # åŠ è½½å¿…è¦çš„åº“å‡½æ•°
    load_required_libraries
    
    # æ‰§è¡Œé¡¹ç›®å¥åº·åº¦è¯„ä¼°ï¼ˆç°æœ‰é¡¹ç›®ï¼‰
    echo "ğŸ¥ æ‰§è¡Œé¡¹ç›®å¥åº·åº¦è¯„ä¼°..."
    HEALTH_PERCENTAGE=$(assess_project_health "$TARGET_DIR" "$FINAL_PROJECT_TYPE" 2>&1 | tail -1)
    echo "ğŸ“Š é¡¹ç›®å¥åº·åº¦: $HEALTH_PERCENTAGE%"
    echo ""
    
    # æ‰§è¡Œæ³¨å…¥æ›´æ–°æµç¨‹
    execute_project_injection
}

# æ‰§è¡Œé¡¹ç›®åˆ›å»ºæµç¨‹
execute_project_creation() {
    # åˆ›å»ºæ ‡å‡†é¡¹ç›®ç»“æ„
    echo "ğŸ—ï¸ åˆ›å»º $FINAL_PROJECT_TYPE æ ‡å‡†é¡¹ç›®ç»“æ„..."
    create_standard_project_structure "$TARGET_DIR" "$FINAL_PROJECT_TYPE" "$PROJECT_NAME"
    echo ""
    
    # åˆå§‹åŒ–éƒ¨ç½²ç­–ç•¥ç®¡ç†
    if [ -f "$TARGET_DIR/deployments/docker-compose.smart.yml" ]; then
        echo "ğŸš€ æ£€æµ‹åˆ°æ™ºèƒ½éƒ¨ç½²é…ç½®ï¼Œè·³è¿‡ä¼ ç»Ÿéƒ¨ç½²ç­–ç•¥ç®¡ç†å™¨..."
    else
        echo "ğŸš€ åˆå§‹åŒ–æ™ºèƒ½éƒ¨ç½²ç­–ç•¥..."
        init_deployment_strategy_manager "$TARGET_DIR" "$FINAL_PROJECT_TYPE" "$PROJECT_NAME"
    fi
    echo ""
    
    # åˆå§‹åŒ–å›½é™…åŒ–åŠŸèƒ½
    echo "ğŸŒ åˆå§‹åŒ–å›½é™…åŒ–åŠŸèƒ½..."
    init_internationalization_manager "$TARGET_DIR" "$FINAL_PROJECT_TYPE" "$PROJECT_NAME"
    echo ""
    
    # åˆ›å»º.Claudeç›®å½•ç»“æ„
    echo "ğŸ“ åˆ›å»ºClaude Codeé…ç½®ç›®å½•..."
    mkdir -p "$TARGET_DIR/.claude"
    
    # ç”Ÿæˆé¡¹ç›®é…ç½®æ–‡ä»¶
    generate_project_config
    
    # ç”Ÿæˆè½»é‡çº§CLAUDE.md
    generate_claude_md
    
    # åˆ›å»ºé¡¹ç›®è¿‡ç¨‹è·Ÿè¸ªç›®å½•
    create_project_process_dirs
    
    # åˆ›å»ºå…¨å±€åŸºç¡€ç»“æ„
    create_global_base_structure
    
    # éªŒè¯é…ç½®
    verify_configuration
    
    # æ˜¾ç¤ºå®Œæˆä¿¡æ¯
    show_completion_summary
}

# æ‰§è¡Œé¡¹ç›®æ³¨å…¥æµç¨‹
execute_project_injection() {
    # æ³¨å…¥æ¨¡å¼ï¼šåªæ›´æ–°é…ç½®ï¼Œä¸ç ´åç°æœ‰ç»“æ„
    echo "ğŸ”„ æ›´æ–°é¡¹ç›®é…ç½®ï¼ˆæ³¨å…¥æ¨¡å¼ï¼‰..."
    
    # å¤‡ä»½ç°æœ‰é…ç½®
    if [ -f "$TARGET_DIR/.claude/project.json" ]; then
        cp "$TARGET_DIR/.claude/project.json" "$TARGET_DIR/.claude/project.json.backup.$(date +%Y%m%d_%H%M%S)"
        echo "   ğŸ“‹ å·²å¤‡ä»½ç°æœ‰é…ç½®"
    fi
    
    # åˆ›å»º.claudeç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    mkdir -p "$TARGET_DIR/.claude"
    
    # ç”Ÿæˆæ›´æ–°çš„é¡¹ç›®é…ç½®æ–‡ä»¶
    generate_project_config
    
    # æ›´æ–°CLAUDE.mdï¼ˆå¦‚æœéœ€è¦ï¼‰
    if [ ! -f "$TARGET_DIR/CLAUDE.md" ] || [ "$TARGET_DIR/CLAUDE.md" -ot "$TARGET_DIR/.claude/project.json" ]; then
        echo "ğŸ“„ æ›´æ–°CLAUDE.md..."
        generate_claude_md
    else
        echo "ğŸ“„ CLAUDE.mdå·²å­˜åœ¨ä¸”è¾ƒæ–°ï¼Œè·³è¿‡æ›´æ–°"
    fi
    
    # åˆ›å»ºç¼ºå¤±çš„åŸºç¡€ç›®å½•
    echo "ğŸ“ æ£€æŸ¥å¹¶åˆ›å»ºç¼ºå¤±çš„åŸºç¡€ç›®å½•..."
    mkdir -p "$TARGET_DIR/project_process"/{daily,reports,prps,bugfixes,analysis}
    mkdir -p "$TARGET_DIR/project_docs"
    
    # æ£€æŸ¥å‘½ä»¤é…ç½®
    check_command_configuration
    
    # éªŒè¯é…ç½®
    verify_configuration
    
    # æ˜¾ç¤ºæ³¨å…¥å®Œæˆä¿¡æ¯
    show_injection_summary
}

# ç”Ÿæˆé¡¹ç›®é…ç½®æ–‡ä»¶
generate_project_config() {
    echo "âš™ï¸ ç”Ÿæˆé¡¹ç›®é…ç½®æ–‡ä»¶..."
    cat > "$TARGET_DIR/.claude/project.json" << EOF
{
  "project_id": "$PROJECT_ID",
  "project_name": "$PROJECT_NAME",
  "project_type": "$FINAL_PROJECT_TYPE",
  "tech_stack": "$TECH_STACK",
  "owner": "$FINAL_OWNER",
  "global_ce_path": "$GLOBAL_CE_PATH",
  "auto_load_context": true,
  "enabled_workflows": [
    "smart-feature-dev",
    "smart-bugfix",
    "smart-code-refactor"
  ],
  "enabled_commands": [
    "load-global-context",
    "smart-feature-dev",
    "smart-bugfix",
    "smart-code-refactor",
    "project-status-analysis",
    "cleanup-project",
    "commit-github"
  ],
  "quality_gates": {
    "lint_command": "make lint",
    "test_command": "make test",
    "typecheck_command": "make typecheck",
    "security_command": "make security-scan"
  },
  "memory_context": "${FINAL_PROJECT_TYPE}_${PROJECT_NAME}",
  "ce_version": "$SCRIPT_VERSION",
  "created_at": "$TIMESTAMP",
  "last_sync": "$TIMESTAMP"
}
EOF
    echo "   âœ… é¡¹ç›®é…ç½®æ–‡ä»¶: .claude/project.json"
}

# ç”Ÿæˆè½»é‡çº§CLAUDE.md
generate_claude_md() {
    echo "ğŸ“„ ç”Ÿæˆè½»é‡çº§CLAUDE.md..."
    
    # æ£€æŸ¥é¡¹ç›®ç±»å‹æ¨¡æ¿æ˜¯å¦å­˜åœ¨
    PROJECT_TYPE_TEMPLATE="$GLOBAL_RULES_PATH/share/claude-autopilot/project-types/${FINAL_PROJECT_TYPE}.md"
    if [ -f "$PROJECT_TYPE_TEMPLATE" ]; then
        # ä½¿ç”¨é¡¹ç›®ç±»å‹ä¸“ç”¨æ¨¡æ¿ï¼Œå¹¶æ›¿æ¢å˜é‡
        sed -e "s/\$PROJECT_NAME/$PROJECT_NAME/g" \
            -e "s/\$TECH_STACK/$TECH_STACK/g" \
            -e "s/\$SCRIPT_VERSION/$SCRIPT_VERSION/g" \
            -e "s/\$TIMESTAMP/$TIMESTAMP/g" \
            -e "s|\$GLOBAL_CE_PATH|$GLOBAL_CE_PATH|g" \
            "$PROJECT_TYPE_TEMPLATE" > "$TARGET_DIR/CLAUDE.md"
        echo "   âœ… ä½¿ç”¨é¡¹ç›®ç±»å‹æ¨¡æ¿: ${FINAL_PROJECT_TYPE}.md"
    else
        # ç”Ÿæˆé€šç”¨æ¨¡æ¿
        echo "   âš ï¸ é¡¹ç›®ç±»å‹ '$FINAL_PROJECT_TYPE' æœªåœ¨ project_types/ ä¸­å®šä¹‰"
        echo "   ğŸ“ ç”Ÿæˆé€šç”¨æ¨¡æ¿"
        generate_generic_claude_md
    fi
    echo "   âœ… è½»é‡çº§CLAUDE.mdæ–‡ä»¶å·²ç”Ÿæˆ"
}

# ç”Ÿæˆé€šç”¨CLAUDE.mdæ¨¡æ¿
generate_generic_claude_md() {
    cat > "$TARGET_DIR/CLAUDE.md" << EOF
# CLAUDE.md - æ™ºèƒ½AIåä½œæŒ‡å—

## ğŸš€ **æ™ºèƒ½Claude Autopilot 2.1 å·²æ¿€æ´»**

æœ¬é¡¹ç›®å·²é›†æˆæ™ºèƒ½Claude Autopilot 2.1ç³»ç»Ÿï¼Œæ”¯æŒå®Œæ•´çš„æ™ºèƒ½å¼€å‘å·¥ä½œæµç¨‹ã€‚

### **ğŸ“Š é¡¹ç›®ä¿¡æ¯**
- **é¡¹ç›®åç§°**: $PROJECT_NAME
- **é¡¹ç›®ç±»å‹**: $FINAL_PROJECT_TYPE
- **æŠ€æœ¯æ ˆ**: $TECH_STACK
- **é¡¹ç›®æ‰€æœ‰è€…**: $FINAL_OWNER
- **é¡¹ç›®ID**: $PROJECT_ID
- **CEç‰ˆæœ¬**: $SCRIPT_VERSION
- **é…ç½®æ—¶é—´**: $TIMESTAMP

### **ğŸ¯ æ™ºèƒ½å‘½ä»¤**

#### **æ ¸å¿ƒå¼€å‘æµç¨‹**
\`\`\`bash
# ä¸€é”®å¼å®Œæ•´åŠŸèƒ½å¼€å‘ / Smart Feature Development
/æ™ºèƒ½åŠŸèƒ½å¼€å‘ <åŠŸèƒ½éœ€æ±‚æè¿°>
# OR /smart-feature-dev <feature description>

# æ™ºèƒ½é—®é¢˜è¯Šæ–­å’Œä¿®å¤ / Smart Bug Fix
/æ™ºèƒ½Bugä¿®å¤ <é—®é¢˜æè¿°>
# OR /smart-bugfix <problem description>

# åŸºäºæœ€ä½³å®è·µçš„æ™ºèƒ½é‡æ„ / Smart Code Refactor
/æ™ºèƒ½ä»£ç é‡æ„ <é‡æ„ç›®æ ‡>
# OR /smart-code-refactor <refactor target>
\`\`\`

#### **è¾…åŠ©å·¥å…·å‘½ä»¤**
\`\`\`bash
# é‡æ–°åŠ è½½å…¨å±€ä¸Šä¸‹æ–‡å’Œç»éªŒ / Load Global Context
/åŠ è½½å…¨å±€ä¸Šä¸‹æ–‡
# OR /load-global-context

# å¼ºåˆ¶åˆ·æ–°æ¨¡å¼ï¼ˆè·å–æœ€æ–°ä¿¡æ¯ï¼‰
/åŠ è½½å…¨å±€ä¸Šä¸‹æ–‡ --force-refresh
# OR /load-global-context --force-refresh

# é¡¹ç›®å¥åº·åº¦åˆ†æ / Project Status Analysis
/é¡¹ç›®çŠ¶æ€åˆ†æ
# OR /project-status-analysis

# æ¸…ç†æ®‹ä½™æ–‡ä»¶ / Cleanup Project
/æ¸…ç†æ®‹ä½™æ–‡ä»¶
# OR /cleanup-project

# æäº¤åˆ°GitHub / Commit to GitHub
/æäº¤github
# OR /commit-github
\`\`\`

### **ğŸ§  æ™ºèƒ½èƒ½åŠ›**

#### **MCPå·¥å…·é“¾é›†æˆ**
- **sequential-thinking**: å¤æ‚ä»»åŠ¡æ™ºèƒ½åˆ†è§£å’Œé£é™©è¯„ä¼°
- **context7**: åŠ¨æ€è·å–æœ€æ–°æŠ€æœ¯æ–‡æ¡£å’Œæœ€ä½³å®è·µ
- **memory**: å†å²å¼€å‘ç»éªŒè‡ªåŠ¨å¤ç”¨
- **puppeteer**: Webé¡¹ç›®è‡ªåŠ¨åŒ–æµ‹è¯•éªŒè¯

#### **å…¨å±€è§„åˆ™éµå®ˆ**
- **å¼ºåˆ¶è§„åˆ™**: è‡ªåŠ¨åº”ç”¨å®‰å…¨ã€è´¨é‡ã€APIè®¾è®¡è§„èŒƒ
- **ç¦æ­¢è§„åˆ™**: è‡ªåŠ¨æ£€æµ‹å’Œé˜»æ­¢è¿è§„æ“ä½œ
- **è´¨é‡é—¨**: å¤šå±‚æ¬¡è‡ªåŠ¨éªŒè¯ç¡®ä¿ä»£ç è´¨é‡

---

**Claude Autopilotè·¯å¾„**: $GLOBAL_CE_PATH
**é¡¹ç›®é…ç½®**: .claude/project.json
**æœ€ååŒæ­¥**: $TIMESTAMP
**CEç‰ˆæœ¬**: v$SCRIPT_VERSION

*æœ¬æ–‡ä»¶ç”±Claude Autopilotæ³¨å…¥è„šæœ¬è‡ªåŠ¨ç”Ÿæˆ*
EOF
}

# åˆ›å»ºé¡¹ç›®è¿‡ç¨‹è·Ÿè¸ªç›®å½•
create_project_process_dirs() {
    echo "ğŸ“ åˆ›å»ºé¡¹ç›®è¿‡ç¨‹è·Ÿè¸ªç›®å½•..."
    mkdir -p "$TARGET_DIR/project_process"/{daily,reports,prps,bugfixes,analysis}
    
    cat > "$TARGET_DIR/project_process/README.md" << EOF
# é¡¹ç›®è¿‡ç¨‹è®°å½•

è¿™ä¸ªç›®å½•ç”¨äºæ™ºèƒ½Claude Autopilot 2.1ç³»ç»Ÿè‡ªåŠ¨è®°å½•å¼€å‘è¿‡ç¨‹ã€‚

## ç›®å½•è¯´æ˜
- \`daily/\` - æ¯æ—¥å¼€å‘è®°å½•
- \`reports/\` - å®ŒæˆæŠ¥å‘Šå’Œåˆ†æ
- \`prps/\` - æ™ºèƒ½PRPæ–¹æ¡ˆæ–‡æ¡£
- \`bugfixes/\` - Bugä¿®å¤è®°å½•
- \`analysis/\` - éœ€æ±‚åˆ†æç»“æœ

## è‡ªåŠ¨ç”Ÿæˆ
æ‰€æœ‰æ–‡ä»¶ç”±Claude Autopilotç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆï¼Œè®°å½•å¼€å‘è¿‡ç¨‹å’Œç»éªŒã€‚
EOF
    
    echo "   âœ… é¡¹ç›®è¿‡ç¨‹ç›®å½•ç»“æ„å·²åˆ›å»º"
}

# åˆ›å»ºå…¨å±€åŸºç¡€ç»“æ„
create_global_base_structure() {
    echo "ğŸ“ åˆ›å»ºå…¨å±€åŸºç¡€ç»“æ„..."
    
    # åˆ›å»ºproject_docsç›®å½•
    if [ ! -d "$TARGET_DIR/project_docs" ]; then
        mkdir -p "$TARGET_DIR/project_docs"
        echo "   âœ… åˆ›å»ºç›®å½•: project_docs/"
    fi
    
    # åˆ›å»º.vscodeç›®å½•å’Œé…ç½®
    if [ ! -d "$TARGET_DIR/.vscode" ]; then
        mkdir -p "$TARGET_DIR/.vscode"
        
        # VSCode settings.json
        cat > "$TARGET_DIR/.vscode/settings.json" << 'EOF'
{
    "editor.tabSize": 2,
    "editor.insertSpaces": true,
    "editor.formatOnSave": true,
    "files.autoSave": "onFocusChange",
    "files.exclude": {
        "**/node_modules": true,
        "**/dist": true,
        "**/*.pyc": true,
        "**/__pycache__": true
    }
}
EOF
        
        echo "   âœ… åˆ›å»ºæ–‡ä»¶: .vscode/settings.json"
    fi
    
    # åˆ›å»º.editorconfig
    if [ ! -f "$TARGET_DIR/.editorconfig" ]; then
        cat > "$TARGET_DIR/.editorconfig" << 'EOF'
root = true

[*]
charset = utf-8
end_of_line = lf
insert_final_newline = true
trim_trailing_whitespace = true
indent_style = space
indent_size = 2

[*.md]
trim_trailing_whitespace = false

[*.{py,go}]
indent_size = 4

[Makefile]
indent_style = tab
EOF
        
        echo "   âœ… åˆ›å»ºæ–‡ä»¶: .editorconfig"
    fi
    
    echo "   âœ… å…¨å±€åŸºç¡€ç»“æ„åˆ›å»ºå®Œæˆ"
}

# æ£€æŸ¥å‘½ä»¤é…ç½®
check_command_configuration() {
    echo "ğŸ”— æ£€æŸ¥å‘½ä»¤é…ç½®..."
    md_files_count=$(find "$TARGET_DIR/.claude/commands" -name "*.md" 2>/dev/null | wc -l)
    if [ "$md_files_count" -gt 0 ]; then
        echo "   âœ… Claudeå‘½ä»¤æ–‡ä»¶å·²å¤åˆ¶åˆ°é¡¹ç›® (${md_files_count}ä¸ª)"
    elif [ ! -L "$TARGET_DIR/.claude/commands" ]; then
        echo "   ğŸ”— åˆ›å»ºå…¨å±€å‘½ä»¤é“¾æ¥ï¼ˆå›é€€æ–¹æ¡ˆï¼‰..."
        ln -sf "$GLOBAL_RULES_PATH/share/claude-autopilot/commands" "$TARGET_DIR/.claude/commands"
        echo "   âœ… å…¨å±€å‘½ä»¤é“¾æ¥: .claude/commands -> $GLOBAL_RULES_PATH/share/claude-autopilot/commands"
    else
        echo "   â„¹ï¸ å‘½ä»¤é“¾æ¥å·²å­˜åœ¨"
    fi
}

# éªŒè¯é…ç½®
verify_configuration() {
    echo "âœ… éªŒè¯Claude Autopiloté…ç½®..."
    
    # æ£€æŸ¥Claude Autopilotç³»ç»Ÿ
    echo "ğŸ” éªŒè¯Claude Autopilotç³»ç»Ÿ..."
    WORKFLOWS_COUNT=$(find "$GLOBAL_RULES_PATH/share/claude-autopilot/workflows" -name "*.md" 2>/dev/null | wc -l)
    COMMANDS_COUNT=$(find "$GLOBAL_RULES_PATH/share/claude-autopilot/commands" -name "*.md" 2>/dev/null | wc -l)
    TEMPLATES_COUNT=$(find "$GLOBAL_RULES_PATH/share/claude-autopilot/templates" -name "*.md" 2>/dev/null | wc -l)
    
    echo "   ğŸ“‹ æ™ºèƒ½å·¥ä½œæµç¨‹: $WORKFLOWS_COUNT ä¸ª"  
    echo "   ğŸ› ï¸ æ™ºèƒ½å‘½ä»¤: $COMMANDS_COUNT ä¸ª"
    echo "   ğŸ“„ æ™ºèƒ½æ¨¡æ¿: $TEMPLATES_COUNT ä¸ª"
    
    # æ£€æŸ¥é¡¹ç›®é…ç½®å®Œæ•´æ€§
    echo "ğŸ” éªŒè¯é¡¹ç›®é…ç½®å®Œæ•´æ€§..."
    if [ -f "$TARGET_DIR/.claude/project.json" ]; then
        echo "   âœ… é¡¹ç›®é…ç½®æ–‡ä»¶å­˜åœ¨"
    else
        echo "   âŒ é¡¹ç›®é…ç½®æ–‡ä»¶ç¼ºå¤±"
        exit 1
    fi
    
    if [ -f "$TARGET_DIR/CLAUDE.md" ]; then
        echo "   âœ… CLAUDE.mdæ–‡ä»¶å·²ç”Ÿæˆ"
    else
        echo "   âŒ CLAUDE.mdæ–‡ä»¶ç”Ÿæˆå¤±è´¥"
        exit 1
    fi
}

# æ˜¾ç¤ºå®Œæˆæ‘˜è¦
show_completion_summary() {
    echo ""
    echo "ğŸŠ Claude Autopilot 2.1 é…ç½®å®Œæˆï¼"
    echo "================================================"
    echo ""
    show_project_summary
    show_usage_instructions
}

# æ˜¾ç¤ºæ³¨å…¥æ‘˜è¦
show_injection_summary() {
    echo ""
    echo "ğŸŠ Claude Autopilot 2.1 æ³¨å…¥å®Œæˆï¼"
    echo "================================================"
    echo ""
    show_project_summary
    show_usage_instructions
}

# æ˜¾ç¤ºé¡¹ç›®æ‘˜è¦
show_project_summary() {
    echo "ğŸ“Š **é¡¹ç›®æ‘˜è¦**:"
    echo "   ğŸ“‚ é¡¹ç›®: $PROJECT_NAME ($FINAL_PROJECT_TYPE)"
    echo "   ğŸ‘¤ æ‰€æœ‰è€…: $FINAL_OWNER"
    echo "   ğŸ†” é¡¹ç›®ID: $PROJECT_ID"
    echo "   ğŸ”§ æŠ€æœ¯æ ˆ: $TECH_STACK"
    echo "   ğŸ¥ å¥åº·åº¦: $HEALTH_PERCENTAGE%"
    echo "   âš™ï¸ é…ç½®æ–‡ä»¶: .claude/project.json"
    echo "   ğŸ“„ æŒ‡å—æ–‡ä»¶: CLAUDE.md"
    echo "   ğŸ“ è¿‡ç¨‹ç›®å½•: project_process/"
    echo ""
}

# æ˜¾ç¤ºä½¿ç”¨è¯´æ˜
show_usage_instructions() {
    echo "ğŸš€ **å¯ç”¨çš„æ™ºèƒ½å‘½ä»¤ / Available Smart Commands**:"
    echo "   â€¢ /æ™ºèƒ½åŠŸèƒ½å¼€å‘ <åŠŸèƒ½æè¿°>        OR  /smart-feature-dev <feature description>"
    echo "   â€¢ /æ™ºèƒ½Bugä¿®å¤ <é—®é¢˜æè¿°>         OR  /smart-bugfix <problem description>"
    echo "   â€¢ /æ™ºèƒ½ä»£ç é‡æ„ <é‡æ„ç›®æ ‡>       OR  /smart-code-refactor <refactor target>"
    echo "   â€¢ /åŠ è½½å…¨å±€ä¸Šä¸‹æ–‡               OR  /load-global-context"
    echo "   â€¢ /é¡¹ç›®çŠ¶æ€åˆ†æ                OR  /project-status-analysis"
    echo "   â€¢ /æ¸…ç†æ®‹ä½™æ–‡ä»¶                OR  /cleanup-project"
    echo "   â€¢ /æäº¤github                  OR  /commit-github"
    echo ""
    echo "ğŸ’¡ **å¼€å§‹ä½¿ç”¨**:"
    echo "   1. è¿›å…¥é¡¹ç›®ç›®å½•: cd $TARGET_DIR"
    echo "   2. å¯åŠ¨Claude Code: claude code"
    echo "   3. ç›´æ¥æè¿°éœ€æ±‚å¼€å§‹æ™ºèƒ½å¼€å‘ï¼"
    echo ""
    echo "ğŸ“š **è·å–å¸®åŠ©**:"
    echo "   - å…¨å±€æ–‡æ¡£: $GLOBAL_CE_PATH/README.md"
    echo "   - é¡¹ç›®æŒ‡å—: CLAUDE.md"
    echo ""
    echo "âœ¨ **äº«å—æ™ºèƒ½å¼€å‘ä½“éªŒï¼**"
}

# æ‰§è¡Œä¸»è¦çš„çŠ¶æ€å¤„ç†é€»è¾‘
case "$PROJECT_STATUS" in
    "CREATE_NEW")
        handle_create_new_mode
        ;;
    "INJECT_EXISTING") 
        handle_inject_existing_mode
        ;;
    "NON_EMPTY_NON_PROJECT")
        handle_non_empty_non_project_mode
        ;;
    *)
        echo "âŒ æœªçŸ¥çš„é¡¹ç›®çŠ¶æ€: $PROJECT_STATUS"
        exit 1
        ;;
esac

# è„šæœ¬æ‰§è¡Œå®Œæˆ
echo ""
echo "ğŸ‰ è„šæœ¬æ‰§è¡Œå®Œæˆï¼"

# ç¡®ä¿å½“å‰è„šæœ¬æœ‰æ‰§è¡Œæƒé™
chmod +x "$0"
